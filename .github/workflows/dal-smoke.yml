name: DAL Smoke

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Override symbol (optional)"
        required: false
      vendor:
        description: "Override vendor (optional)"
        required: false
      interval:
        description: "Override interval (optional)"
        required: false
      lookback_days:
        description: "Override lookback window in days (optional)"
        required: false
  schedule:
    - cron: "0 6 * * 1"

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      PYTHONUNBUFFERED: "1"
      ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
      ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
      ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
      FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
      TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
      MARKETSTACK_API_KEY: ${{ secrets.MARKETSTACK_API_KEY }}
      BACKTEST_NO_SAVE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run DAL smoke harness
        env:
          CUSTOM_CHECK: ${{ inputs.vendor && format('{0}:{1}:{2}:{3}', inputs.vendor, inputs.symbol || 'AAPL', inputs.interval || '1Day', inputs.lookback_days || '60') || '' }}
        run: |
          mkdir -p artifacts/ops/dal_smoke
          if [ -n "$CUSTOM_CHECK" ]; then
            python scripts/dal_smoke.py \
              --output-dir artifacts/ops/dal_smoke \
              --check "$CUSTOM_CHECK"
          else
            python scripts/dal_smoke.py \
              --output-dir artifacts/ops/dal_smoke
          fi

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: dal-smoke-report
          path: artifacts/ops/dal_smoke
          if-no-files-found: warn
