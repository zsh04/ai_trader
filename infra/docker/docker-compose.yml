version: "3.8"

# Defines the services for your application and the OTel collector

services:
  app:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    ports:
      # Exposes your FastAPI app
      - "8000:8000"
    environment:
      # --- Sentry & App Env ---
      # These values are read from your .env.dev file
      - SENTRY_DSN=${SENTRY_DSN}
      - APP_ENVIRONMENT=${APP_ENVIRONMENT} 
      
      # --- OpenTelemetry ---
      # Tells the app to send telemetry to the collector service
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://ai-trader-otel.wonderfulfield-e5e6ab0a.westus2.azurecontainerapps.io
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=https://ai-trader-otel.wonderfulfield-e5e6ab0a.westus2.azurecontainerapps.io/v1/traces
      - OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=https://ai-trader-otel.wonderfulfield-e5e6ab0a.westus2.azurecontainerapps.io/v1/metrics
      - OTEL_EXPORTER_OTLP_LOGS_ENDPOINT=https://ai-trader-otel.wonderfulfield-e5e6ab0a.westus2.azurecontainerapps.io/v1/logs
      # This service name will show up in Grafana
      - OTEL_SERVICE_NAME=ai-trader-app
      - OTEL_LOGS_EXPORTER=otlp
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=otlp
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      # --- Other Secrets ---
      # Add other env vars your app needs
      # - DATABASE_URL=${DATABASE_URL}
      # - ALPCA_API_KEY=${ALPCA_API_KEY}
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - ai-trader-net
    depends_on:
      - otel-collector

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    volumes:
      # Mounts the config file into the container
      - ../otel/collector-config.yml:/etc/otelcol-contrib/config.yaml:ro
    ports:
      # Exposes OTLP ports to your local machine (for ./dev.sh)
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    environment:
      # Injects the environment variable into the collector's config
      - APP_ENVIRONMENT=${APP_ENVIRONMENT}
      - GRAFANA_OTLP_ENDPOINT=${GRAFANA_OTLP_ENDPOINT}
      - GRAFANA_BASIC_AUTH=${GRAFANA_BASIC_AUTH}
      - SERVICE_NAME=ai-trader-app
      - SERVICE_INSTANCE_ID=otel-local
    healthcheck:
      test: ["CMD-SHELL", "stat /etc/otelcol-contrib/config.yml || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - ai-trader-net
    restart: always

networks:
  ai-trader-net:
    driver: bridge
