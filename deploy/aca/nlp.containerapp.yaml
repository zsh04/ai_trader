# Azure Container Apps manifest for ai-trader-nlp (FinBERT)
# Replace the __PLACEHOLDER__ tokens before applying.
type: Microsoft.App/containerApps
name: ai-trader-nlp
location: __LOCATION__
identity:
  type: SystemAssigned
properties:
  environmentId: /subscriptions/__SUBSCRIPTION_ID__/resourceGroups/__RG__/providers/Microsoft.App/managedEnvironments/__ENV__
  configuration:
    ingress:
      external: false
      targetPort: 8000
    activeRevisionsMode: Single
    secrets:
      - name: otlp-headers
        value: __OTEL_HEADERS__
    registries:
      - server: __ACR_NAME__.azurecr.io
        identity: system
    logs:
      destinations:
        - name: log-analytics
          logAnalytics:
            customerId: __LOG_ANALYTICS_CUSTOMER_ID__
    dapr:
      enabled: false
  template:
    revisionSuffix: sprint-__SPRINT_TAG__
    containers:
      - name: ai-trader-nlp
        image: __ACR_NAME__.azurecr.io/ai-trader-nlp:__IMAGE_TAG__
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: APP_ENVIRONMENT
            value: __APP_ENVIRONMENT__
          - name: HF_COMMIT_SHA
            value: __HF_COMMIT_SHA__
          - name: MODEL_ID_FINBERT
            value: ProsusAI/finbert
          - name: ADAPTER_TAG
            value: __ADAPTER_TAG_NLP__
          - name: BAKED_ADAPTER_TAG
            value: __BAKED_ADAPTER_TAG_NLP__
          - name: STORAGE_ACCOUNT
            value: __STG_ACCOUNT__
          - name: BLOB_MODELS_URL
            value: blob://models
          - name: BLOB_ADAPTERS_URL
            value: blob://adapters
          - name: MODEL_CACHE_DIR
            value: /models-cache
          - name: OTEL_EXPORTER_OTLP_ENDPOINT
            value: __OTEL_ENDPOINT__
          - name: OTEL_EXPORTER_OTLP_HEADERS
            value: secretref:otlp-headers
        probes:
          - type: liveness
            httpGet:
              path: /healthz
              port: 8000
            initialDelaySeconds: 10
          - type: readiness
            httpGet:
              path: /ready
              port: 8000
            initialDelaySeconds: 10
    scale:
      minReplicas: 0
      maxReplicas: 2
      rules:
        - name: cpu-scale
          custom:
            type: cpu
            metadata:
              utilization: "70"
        - name: http-rps
          http:
            metadata:
              concurrentRequests: "5"
