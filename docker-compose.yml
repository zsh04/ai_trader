version: "3.8"

# Defines the services for your application and the OTel collector

services:
  app:
    # This assumes your Dockerfile is in the current directory
    build: .
    ports:
      # Exposes your FastAPI app
      - "8000:8000"
    environment:
      # --- Sentry & App Env ---
      # These values are read from your .env.dev file
      - SENTRY_DSN=${SENTRY_DSN}
      - APP_ENVIRONMENT=${APP_ENVIRONMENT} 
      
      # --- OpenTelemetry ---
      # Tells the app to send telemetry to the collector service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http:///localhost:4317
      # This service name will show up in Grafana
      - OTEL_SERVICE_NAME=ai-trader-app
      - OTEL_LOGS_EXPORTER=otlp
      # --- Other Secrets ---
      # Add other env vars your app needs
      # - DATABASE_URL=${DATABASE_URL}
      # - ALPCA_API_KEY=${ALPCA_API_KEY}
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - ai-trader-net
    depends_on:
      - otel-collector

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    volumes:
      # Mounts the config file into the container
      - ./otel-collector-config.yml:/etc/otelcol-contrib/config.yml:ro
    ports:
      # Exposes OTLP ports to your local machine (for ./dev.sh)
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    environment:
      # Injects the environment variable into the collector's config
      - APP_ENVIRONMENT=${APP_ENVIRONMENT}
    healthcheck:
      test: ["CMD-SHELL", "stat /etc/otelcol-contrib/config.yml || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - ai-trader-net
    restart: always

networks:
  ai-trader-net:
    driver: bridge